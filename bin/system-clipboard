#!/usr/bin/env bash
# Interact with system clipboards

if ! [ -t 0 ]; then # there's something being piped in
  operation="put"
  read content
else
  operation="get"
fi

if [[ $1 == "get" ]]; then
  operation="get"
elif [[ $1 == "put" ]]; then
  operation="put"
fi

while getopts “Tth” OPTION
do
  case $OPTION in
    t) # tmux
      use_tmux="true"
      ;;
    T) # tmux sync only
      use_tmux="true"
      synconly="true"
      ;;
    h)
      echo "usage: access the system clipboard"
      echo "$(basename $0) get"
      echo "<command with output> | $(basename $0) put"
      echo "-t    : sync tmux buffers and operate as normal"
      echo "-T    : sync tmux buffers only (*no* I/O - no paste, no buffer changes)"
      exit 0
      ;;
  esac
done

if ! [[ -n $(command -v pbcopy) ]]; then

  # try linux with X
  if [[ -n $(command -v xclip) ]]; then
    alias pbcopy="xclip -selection c -i"
    alias pbpaste="xclip -selection clipboard -o"
  else
    echo "Couldn't find xclip or pbcopy, "
    exit 127
  fi

fi

if [[ $operation == "get" ]]; then
  if [ -n "$use_tmux" ]; then

    tmux set-buffer -- "$(pbpaste)"

    if [ -z "$synconly" ]; then
      tmux paste-buffer
    fi

  else # no tmux
    pbpaste
  fi

elif [[ $operation == "put" ]]; then

  if [ -n "$use_tmux" ]; then
    if [ -z "$synconly" ] && [ -n "$content" ]; then
      tmux set-buffer -- "$content"
    fi

    tmux show-buffer | pbcopy

  else # no tmux
    echo "$content" | pbcopy
  fi


else
  echo "sanity check failed!"
  exit 127
fi
